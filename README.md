# wt-campaign-indexer

Reusable tooling for building a **wind tunnel campaign indexer**. The current milestone (`v0`) focuses on project scaffolding plus a production-ready CLI that creates shortened LabVIEW `.lvm` fixtures around trigger/burst events.

## Campaign folder shape (target)

```text
<campaign_root>/
  FST1387/
  FST1388/
  ...
  FST1391/
    FST_1391.lvm
    schlieren/
      run_C001H001S0001/
        *.cihx
    plif/
      run_C001H001S0001/
        *.cihx
    tracking/
      run_C001H001S0001/
        *.cihx
    piv/
      run_.../
        *.cihx
    ir/
      run_.../
        *.hcc
    kulite/
      *.csv
    readme.txt
```

## Installation / development setup

This repository uses **uv** + `pyproject.toml`.

```bash
uv pip install -e ".[dev]"
```

## CLI: create shortened LVM fixture

Default behavior extracts **Â±100 ms around trigger** and can emit a verification plot.

```bash
wtt-make-lvm-fixture \
  --input /path/to/FST_1391.lvm \
  --output examples/dummy_campaign/FST1391/FST_1391_fixture.lvm \
  --trigger-channel Voltage \
  --burst-channel PLEN-PT \
  --header-row-index 23 \
  --pre-ms 100 \
  --post-ms 100 \
  --plot-output examples/dummy_campaign/FST1391/FST_1391_fixture_check.png \
  --write-metadata-json examples/dummy_campaign/FST1391/FST_1391_fixture.json
```

Failed-burst fixture example (anchor around plenum decrease with slow-rise/quick-fall check):

```bash
wtt-make-lvm-fixture \
  --input /path/to/FST_9999.lvm \
  --output /path/to/FST_9999_failed_burst_fixture.lvm \
  --trigger-channel Voltage \
  --burst-channel PLEN-PT \
  --window-anchor failed-burst-drop \
  --failed-burst-min-rise-to-drop-ms 500 \
  --failed-burst-min-drop-to-rise-grad-ratio 0.5 \
  --decimate 1 \
  --pre-ms 5000 \
  --post-ms 5000
```

### Reader and detection behavior

- Reads LVM data using the same style as your campaign scripts (`header=None`, selected rows via `skiprows`, header loaded separately).
- Handles occasional variable-width rows (e.g., some data rows with 29 fields while header defines 28) by reading only the header-defined column count, which avoids noisy parser warnings.
- Supports `--read-every-n` for faster coarse reads on very large files.
- Reads only the header-defined (or requested) columns to reduce parse overhead on large/variable-width LVM rows.
- Interpolates missing numeric values after loading.
- Detects trigger candidates from `trigger-channel` using rolling-mean + gradient peaks.
- Detects burst index from `burst-channel` using rolling-mean + gradient argmax.
- If several trigger candidates are strong, chooses the one nearest burst.
- Supports failed-burst snippets via `--window-anchor failed-burst-drop`, which anchors around the plenum-pressure decrease and checks for a slow rise followed by a quick fall using configurable thresholds (`--failed-burst-min-rise-to-drop-ms`, `--failed-burst-min-drop-to-rise-grad-ratio`).
- For failed-burst snippets, prefer `--decimate 1` to avoid missing short trigger-like gradients.



To validate an already-generated shortened LVM, you can plot directly from it:

```bash
wtt-plot-lvm-fixture \
  --input examples/dummy_campaign/FST1391/FST_1391_fixture.lvm \
  --output examples/dummy_campaign/FST1391/FST_1391_fixture_check.png \
  --header-row-index 23 \
  --trigger-channel Voltage \
  --plenum-channel PLEN-PT
```

### Output behavior

- Preserves all pre-data header lines through the detected header row.
- Writes a shortened TSV `.lvm`-like file readable by `pandas.read_csv`.
- Keeps all columns in original order.
- Optional metadata JSON captures sample rates, chosen indices, channels, window, and decimation.
- Optional PNG verification plot overlays plenum pressure channel and trigger voltage vs time-from-trigger.



> Note: generated fixture artifacts (`*_fixture.lvm`, `*_fixture.json`, `*_fixture_check.png`) are intentionally git-ignored so PRs do not include binary/large generated files. Generate them locally when validating data cuts.

## Building a dummy campaign under `examples/`

1. Copy a small set of real `FST####/` folders into `examples/dummy_campaign/`.
2. Replace each full `FST_####.lvm` with a fixture generated by `wtt-make-lvm-fixture`.
3. Keep tiny `.cihx` metadata files (and `.hcc` for `ir` runs) in diagnostic `run_*` directories.
4. Optionally keep one tiny non-camera CSV diagnostic (for future rate inference tests).


## CLI: write campaign manifests + summary

Point the tool at a campaign root (including `examples/dummy_campaign`) to generate one manifest per FST plus a markdown health-check summary.

```bash
wtt-write-campaign-summary \
  --campaign-root examples/dummy_campaign \
  --summary-output examples/dummy_campaign/campaign_summary.md \
  --tunnel-mach 7.2 \
  --jet-used \
  --jet-mach 3.09
```

The CLI prints per-folder progress (for example, `Processing FST_1391...`) while manifests/summary are being built.

If `--jet-used`/`--no-jet-used` is omitted and you run in an interactive terminal, the CLI will prompt whether a jet was used and (if yes) ask for jet Mach.

To skip an FST folder from manifest/summary generation, add a `skip.txt` file in that FST folder root (for example: `FST1391/skip.txt`).

## Quality checks

```bash
ruff check .
black --check .
pytest
```

## CI

GitHub Actions runs lint, format checks, and tests on every push/PR.
